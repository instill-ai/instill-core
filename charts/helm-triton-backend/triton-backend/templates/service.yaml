apiVersion: v1
kind: Service
metadata:
  name: {{ template "triton-backend.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    app: {{ template "triton-backend.name" . }}
    chart: {{ template "triton-backend.chart" . }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
spec:
  type: {{ required "Service type is required" .Values.service.type }}
  ports:
    - port: {{ required "HTTP port is required" .Values.service.portHttp }}
      targetPort: http
      {{- if and (eq (.Values.service.type | quote) `"NodePort"`) (.Values.service.nodePortHttp) }}
      {{- if and (ge (.Values.service.nodePortHttp | int) (30000 | int)) (le (.Values.service.nodePortHttp | int) (32767 | int)) }}
      nodePort: {{ .Values.service.nodePortHttp }}
      {{- else }}
      {{- fail (cat "Invalid nodePort port" .Values.service.nodePortHttp ". Please provide a valid nodePort between 30000 and 32767") }}
      {{- end }}
      {{- end }}
      name: http
    - port: {{ required "gRPC port is required" .Values.service.portGrpc }}
      targetPort: grpc
      {{- if and (eq (.Values.service.type | quote) `"NodePort"`) (.Values.service.nodePortGrpc) }}
      {{- if and (ge (.Values.service.nodePortGrpc | int) (30000 | int)) (le (.Values.service.nodePortGrpc | int) (32767 | int)) }}
      nodePort: {{ .Values.service.nodePortGrpc }}
      {{- else }}
      {{- fail (cat "Invalid nodePort port" .Values.service.nodePortGrpc ". Please provide a valid nodePort between 30000 and 32767") }}
      {{- end }}
      {{- end }}
      name: grpc
    - port: {{ required "Metrics port is required" .Values.service.portMetrics }}
      targetPort: metrics
      {{- if and (eq (.Values.service.type | quote) `"NodePort"`) (.Values.service.nodePortMetrics) }}
      {{- if and (ge (.Values.service.nodePortMetrics | int) (30000 | int)) (le (.Values.service.nodePortMetrics | int) (32767 | int)) }}
      nodePort: {{ .Values.service.nodePortMetrics }}
      {{- else }}
      {{- fail (cat "Invalid nodePort port" .Values.service.nodePortMetrics ". Please provide a valid nodePort between 30000 and 32767") }}
      {{- end }}
      {{- end }}
      name: metrics
  selector:
    app: {{ template "triton-backend.name" . }}
    release: {{ .Release.Name }}
