apiVersion: v1
kind: Service
metadata:
  name: {{ include "api-gateway.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "api-gateway.labels" . | nindent 4 }}
{{- if .Values.service.annotations }}
  annotations:
{{ toYaml .Values.service.annotations | indent 4 }}
{{- end }}
spec:
  type: {{ .Values.service.type }}
  ports:
    - port: {{ .Values.apiGateway.port.http }}
      targetPort: {{ .Values.apiGateway.port.http }}
      {{- if and (eq (.Values.service.type | quote) `"NodePort"`) (.Values.service.nodePortHttp) }}
      {{- if and (ge (.Values.service.nodePortHttp | int) (30000 | int)) (le (.Values.service.nodePortHttp | int) (32767 | int)) }}
      nodePort: {{ .Values.service.nodePortHttp }}
      {{- else }}
      {{- fail (cat "Invalid nodePort port" .Values.service.nodePortHttp ". Please provide a valid nodePort between 30000 and 32767") }}
      {{- end }}
      {{- end }}
      protocol: TCP
      name: http
    - port: {{ .Values.apiGateway.port.stats }}
      targetPort: stats
      {{- if and (eq (.Values.service.type | quote) `"NodePort"`) (.Values.service.nodePortStats) }}
      {{- if and (ge (.Values.service.nodePortStats | int) (30000 | int)) (le (.Values.service.nodePortStats | int) (32767 | int)) }}
      nodePort: {{ .Values.service.nodePortStats }}
      {{- else }}
      {{- fail (cat "Invalid nodePort port" .Values.service.nodePortStats ". Please provide a valid nodePort between 30000 and 32767") }}
      {{- end }}
      {{- end }}
      protocol: TCP
      name: stats
    - port: {{ .Values.apiGateway.port.metrics }}
      targetPort: metrics
      {{- if and (eq (.Values.service.type | quote) `"NodePort"`) (.Values.service.nodePortMetrics) }}
      {{- if and (ge (.Values.service.nodePortMetrics | int) (30000 | int)) (le (.Values.service.nodePortMetrics | int) (32767 | int)) }}
      nodePort: {{ .Values.service.nodePortMetrics }}
      {{- else }}
      {{- fail (cat "Invalid nodePort port" .Values.service.nodePortMetrics ". Please provide a valid nodePort between 30000 and 32767") }}
      {{- end }}
      {{- end }}
      protocol: TCP
      name: metrics
  selector:
    {{- include "api-gateway.selectorLabels" . | nindent 4 }}
