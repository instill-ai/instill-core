apiVersion: ray.io/v1
kind: RayCluster
metadata:
  name: raycluster
  namespace: ray
spec:
  rayVersion: "2.47.0"
  gcsFaultToleranceOptions:
    redisAddress: "core-redis.instill-ai.svc.cluster.local:6379"
  headGroupSpec:
    rayStartParams:
      num-cpus: "0"
      num-gpus: "0"
      disable-usage-stats: "true"
    template:
      spec:
        restartPolicy: Always
        containers:
          - name: raycluster-head
            image: instill/ray:0.6.6
            imagePullPolicy: IfNotPresent
            ports:
              - containerPort: 6379
                name: gcs-server
              - containerPort: 8265
                name: dashboard
              - containerPort: 10001
                name: client
              - containerPort: 8000
                name: serve
              - containerPort: 9000
                name: grpc
            env:
              - name: RAY_GRAFANA_IFRAME_HOST
                value: "http://localhost:3001"
              - name: RAY_GRAFANA_HOST
                value: "http://grafana.observability.svc.cluster.local:80"
              - name: RAY_PROMETHEUS_HOST
                value: "http://prometheus-kube-prometheus-prometheus.observability.svc.cluster.local:9090"
              - name: RAY_TASK_MAX_RETRIES
                value: "2"
              - name: RAY_WORKER_REGISTER_TIMEOUT_SECONDS
                value: "3600"
            volumeMounts:
              - mountPath: /home/ray/.local/share/containers
                name: raycluster-head
              - mountPath: /home/ray/.config/containers/
                name: podman-config
            securityContext:
              privileged: true
            lifecycle:
              postStart:
                exec:
                  command:
                    - "/bin/bash"
                    - "-c"
                    - |
                      export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/lib/x86_64-linux-gnu;
                      if [[ -n ${NVIDIA_VISIBLE_DEVICES} ]]; then
                        sudo env PATH=$PATH LD_LIBRARY_PATH=$LD_LIBRARY_PATH nvidia-ctk cdi generate --library-search-path=$LD_LIBRARY_PATH --output=/etc/cdi/nvidia.yaml;
                      fi;
              preStop:
                exec:
                  command: ["/bin/sh", "-c", "ray stop"]
        volumes:
          - name: raycluster-head
            persistentVolumeClaim:
              claimName: raycluster-head
          - name: podman-config
            configMap:
              name: podman-config
              defaultMode: 0666
              items:
                - key: registries.conf
                  path: registries.conf
                - key: policy.json
                  path: policy.json
  workerGroupSpecs:
    - groupName: cpu-group
      rayStartParams:
        num-cpus: "2"
        disable-usage-stats: "true"
      replicas: 1
      minReplicas: 1
      maxReplicas: 1
      template:
        spec:
          restartPolicy: Always
          containers:
            - name: raycluster-worker
              image: instill/ray:0.6.6
              imagePullPolicy: IfNotPresent
              ports:
                - containerPort: 8000
                  name: serve
                - containerPort: 9000
                  name: grpc
              env:
                - name: RAY_TASK_MAX_RETRIES
                  value: "2"
                - name: RAY_WORKER_REGISTER_TIMEOUT_SECONDS
                  value: "3600"
              volumeMounts:
                - mountPath: /home/ray/.local/share/containers
                  name: raycluster-worker
                - mountPath: /home/ray/.config/containers/
                  name: podman-config
              securityContext:
                privileged: true
              lifecycle:
                postStart:
                  exec:
                    command:
                      - "/bin/bash"
                      - "-c"
                      - |
                        export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/lib/x86_64-linux-gnu;
                        if [[ -n ${NVIDIA_VISIBLE_DEVICES} ]]; then
                          sudo env PATH=$PATH LD_LIBRARY_PATH=$LD_LIBRARY_PATH nvidia-ctk cdi generate --library-search-path=$LD_LIBRARY_PATH --output=/etc/cdi/nvidia.yaml;
                        fi;
                        while true; do
                          ray health-check 2>/dev/null;
                          if [ "$?" = "0" ]; then
                              break;
                          fi;
                          sleep 1;
                        done; serve start --http-host=0.0.0.0 --grpc-port 9000 --grpc-servicer-functions user_defined_pb2_grpc.add_UserDefinedServiceServicer_to_server
                preStop:
                  exec:
                    command: ["/bin/sh", "-c", "ray stop"]
          volumes:
            - name: raycluster-worker
              persistentVolumeClaim:
                claimName: raycluster-worker
            - name: podman-config
              configMap:
                name: podman-config
                defaultMode: 0666
                items:
                  - key: registries.conf
                    path: registries.conf
                  - key: policy.json
                    path: policy.json
