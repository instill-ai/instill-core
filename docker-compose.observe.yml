version: "3.9"

services:
  influxdb:
    container_name: ${INFLUXDB_HOST}
    image: ${INFLUXDB_IMAGE}:${INFLUXDB_VERSION}-alpine
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: admin
      DOCKER_INFLUXDB_INIT_PASSWORD: password
      DOCKER_INFLUXDB_INIT_ORG: instill-ai
      DOCKER_INFLUXDB_INIT_BUCKET: krakend
      DOCKER_INFLUXDB_INIT_RETENTION: 1w
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: i-love-instill-ai
    volumes:
      - ./configs/influxdb:/docker-entrypoint-initdb.d
    ports:
      - ${INFLUXDB_PORT}:8086

  otel_collector:
    container_name: ${OTEL_COLLECTOR_HOST}
    image: ${OTEL_COLLECTOR_IMAGE}:${OTEL_COLLECTOR_VERSION}
    command: --config=/configs/otel-collector/config.yaml
    volumes:
      - ./configs:/configs
    depends_on:
      - jaeger
      - prometheus

  jaeger:
    container_name: ${JAEGER_HOST}
    image: ${JAEGER_IMAGE}:${JAEGER_VERSION}
    ports:
      - ${JAEGER_WEB_PORT}:16686 # Web HTTP

  prometheus:
    container_name: ${PROMETHEUS_HOST}
    image: ${PROMETHEUS_IMAGE}:v${PROMETHEUS_VERSION}
    command:
      - --config.file=/configs/prometheus/config.yaml
    volumes:
      - ./configs:/configs
    ports:
      - ${PROMETHEUS_WEB_PORT}:9090

  grafana:
    container_name: ${GRAFANA_HOST}
    image: ${GRAFANA_IMAGE}:${GRAFANA_VERSION}
    volumes:
      - ./configs/grafana/datasources/all.yml:/etc/grafana/provisioning/datasources/all.yml
      - ./configs/grafana/dashboards/all.yml:/etc/grafana/provisioning/dashboards/all.yml
      - ./configs/grafana/krakend:/var/lib/grafana/dashboards/krakend
    ports:
      - ${GRAFANA_PORT}:3000
