name: Check makefile

on:
  push:
    branches:
      - deniz/ins-590-check-makefile

jobs:
  makefile:
    name: check makefile
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
         repository: instill-ai/vdp
         ref: deniz/ins-562-helm-integration-test
      - name: Download and install Helm
        run: |
          curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
          chmod 700 get_helm.sh
          ./get_helm.sh
      - name: Delete huge unnecessary tools folder
        run: rm -rf /usr/share/dotnet && rm -rf /opt/ghc && rm -rf "/usr/local/share/boost" &&  rm -rf "$AGENT_TOOLSDIRECTORY"
      - name: Free disk space
        run: |
          df --human-readable
          sudo apt clean
      - name: Free disk space
        run: |
          wget https://ftp.gnu.org/gnu/make/make-3.81.tar.gz
          tar -xzf make-3.81.tar.gz && cd make-3.81
          sed -i '1i #if defined __GNUC__ && __GNUC__ >= 2\n# define __alloca __builtin_alloca\n# define __stat stat\n#endif' > glob/glob.c
          ./configure && make && make install
        shell: bash
      - name: Change to repository directory
        run: cd ${{ github.workspace }}
      - name: Run make test
        run: make -v && /usr/local/bin/make -v
      - name: check make
        run: /usr/local/bin/make helm-integration-test-release
